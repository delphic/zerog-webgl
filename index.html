<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8"/>
		<title>Gremlin Test Index</title>
		<script type="text/javascript" src="libs/glMatrix-0.9.5.min.js"></script>
		<script type="text/javascript" src="libs/webgl-utils.js"></script>
		<!-- Shaders -->
		<script id="shader-fs" type="x-shader/x-fragment">
			#ifdef GL_ES
			precision highp float;
			#endif

			varying vec4 vColor;

			void main(void) {
				gl_FragColor = vColor;
			}
		</script>
		<script id="shader-vs" type="x-shader/x-vertex">
			attribute vec3 aVertexPosition;
			attribute vec4 aVertexColor;

			uniform mat4 uMVMatrix;
			uniform mat4 uPMatrix;

			varying vec4 vColor;

			void main(void) {
				gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
				vColor = aVertexColor;
			}
		</script>
		<!-- Gremlin Engine -->
		<script type="text/javascript" src="Gremlin.js"></script>
		<!-- Game Script -->
		<script type="text/javascript">
	var canvas;
    var lastTime = 0;

    function animate() {
        var timeNow = new Date().getTime();
        if (lastTime != 0) {
            var elapsed = timeNow - lastTime;
			Gremlin.animate(elapsed);
			
			
			// Handle Input
			// TODO: Separate into function
			// TODO: game state variable... switch on this to control handling of input e.g. Menus
			// TODO: Should not trigger on overlays.
			// BUG: Keys get 'stuck down'
			var dyaw, dpitch, dx, dz;
			dyaw = 0.05 * elapsed * ((canvas.width*0.5)-xPos)/(0.5*canvas.width);
			dpitch = 0.05 * elapsed * ((canvas.height*0.5)-yPos)/(0.5*canvas.height);
			if (mouseDown) Gremlin.rotatePlayerCamera(dyaw, dpitch);
			
			if (currentlyPressedKeys[37] || currentlyPressedKeys[65]) {
				// Left cursor key or A
				// Strafe Left
				dx = -0.005 * elapsed;
			} 
			else if (currentlyPressedKeys[39] || currentlyPressedKeys[68]) {
				// Right cursor key or D
				// Strafe Right
				dx = 0.005  * elapsed;
			}
			else dx = 0;

			if (currentlyPressedKeys[38] || currentlyPressedKeys[87]) {
				// Up cursor key or W
				// Move Forward
				dz = -0.005  * elapsed;
			} else if (currentlyPressedKeys[40] || currentlyPressedKeys[83]) {
				// Down cursor key or S
				// Move Backward
				dz = 0.005  * elapsed;
			} 			
			else dz = 0;
			// TODO: Fix diagonal movement speed
			Gremlin.movePlayerCamera(dx,0,dz);
        }
        lastTime = timeNow;
    }

    function tick() {
        if(controller.isRunning()) { requestAnimFrame(tick); }
        Gremlin.drawScene();
        animate();
    }


    function webGLStart() {
		Gremlin.init();
        tick();
		
		document.onkeydown = handleKeyDown;
		document.onkeyup = handleKeyUp;
		document.onmousemove = handleMouseMove;
		document.onmousedown = handleMouseDown;
		document.onmouseup = handleMouseUp;
    }
	
	var xPos, yPos;
	var currentlyPressedKeys = {};
	var mouseDown = false;

	function handleKeyDown(event) {
        currentlyPressedKeys[event.keyCode] = true;
	}
	function handleKeyUp(event) {
		currentlyPressedKeys[event.keyCode] = false;
	}
	function handleMouseMove(event) {
		// TODO: Investigate the difference between clientX and pageX
		xPos = event.pageX;
		yPos = event.pageY;
	}
	function handleMouseDown(event) {
		// TODO: Add vars for middle and right
		// 0 = left, 1 = middle, 2 = right
		if (!event.button) { mouseDown = true; }
	}
	function handleMouseUp(event) {
		if (!event.button) { mouseDown = false; }
	}
	
	function _controller() {
		// TODO: Move pause functions to Engine.
		var running = true;
		var windowPaused = false;
		
		function handlePause() { 
			if(running) { 
				_pause();
				// TODO: save the control objects
				var btn = document.getElementById("btnPause").value = "Start"; 
			} 
			else { 
				_unpause();
				var btn = document.getElementById("btnPause").value = "Stop"; 
			}
		}
		
		function handleWindowBlur() {
			if(running) {
				windowPaused = true;
				_pause();
			}
		}
		
		function handleWindowFocus() {
			if(windowPaused) {
				windowPaused = false;
				_unpause();
			}
		}		
		function isRunning() { return running; }
		
		function _pause() { running = false; }
		// TODO: when the game timer moves to an object adjust this		
		function _unpause() { running = true; lastTime = new Date().getTime(); requestAnimFrame(tick); }
		
		return { isRunning: isRunning, handlePause: handlePause, handleWindowBlur: handleWindowBlur, handleWindowFocus: handleWindowFocus };
	}
	var controller = _controller();
	
	function fullScreen() {
		canvas = document.getElementById("gremlinCanvas");
		canvas.width = document.width;
		canvas.height = document.height;
	}
	
	// TODO: move window focus handling to Engine
	window.onblur = function() { controller.handleWindowBlur(); }
	window.onfocus = function() { controller.handleWindowFocus(); }
	// window.onresize = function() { fullScreen(); }
	
		</script>
		<style>
			html, body { margin: 0; padding: 0; overflow: hidden; font-family: monospace; }
			input { font-size: 16px; margin: 5px 10px; padding: 3px; background: #000; color: #EEE; border: 1px solid #222; }
			canvas { cursor: crosshair; }
			#controls { width: 100%; position: fixed; top: 0; left: 0; background-color: rgba(127,127,127,0.5); z-index: 10; cursor: default; }
		</style>
	</head>
	<body onload="webGLStart();">
		<div id="controls">
			<input id="btnPause" type="button" onclick="controller.handlePause();" value="Stop" />
			<!-- TODO: Add spawn debug solid -->
		</div>
		<!-- TODO: add inital screen telling you controls -->
		<canvas id="gremlinCanvas">Your browser does not support the HTML5 canvas element, consider upgrading. </canvas>
		<!-- Temporary Full Screen, TODO: add to controls -->
		<script type="text/javascript">
			fullScreen();
		</script>
	</body>
</html>